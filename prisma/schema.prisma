generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  LANDLORD
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  fullName        String
  avatar          String?
  bio             String?
  university      String?
  isVerified      Boolean   @default(false)
  role            Role      @default(USER)
  lastActiveAt    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  listings        Listing[]
  favorites       Favorite[]
  sentMessages    Message[] @relation("SentMessages")
  chats           Chat[]    @relation("UserChats")
  preferences     Preference?
  verification    VerificationRequest?
  adminActions    AdminAction[]
  visitRequests   VisitRequest[] @relation("VisitRequester")
  visitOwned      VisitRequest[] @relation("VisitOwner")
  listingViews    ListingView[]
  reports         Report[]
  notifications   Notification[]
}

model Preference {
  id              String    @id @default(uuid())
  userId          String    @unique
  cleanliness     Int       // 1-5
  studyHabits     Int       // 1-5
  pets            Boolean
  budgetMin       Int
  budgetMax       Int
  gender          String?   // "MALE", "FEMALE", "ANY"
  
  user            User      @relation(fields: [userId], references: [id])
}

model Listing {
  id              String    @id @default(uuid())
  ownerId         String
  title           String
  description     String
  price           Int
  address         String
  latitude        Float
  longitude       Float
  amenities       String[]
  images          Image[]
  viewsCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  status          String    @default("ACTIVE") // ACTIVE, RENTED, INACTIVE

  owner           User      @relation(fields: [ownerId], references: [id])
  favoritedBy     Favorite[]
  views           ListingView[]
  visitRequests   VisitRequest[]
}

model Image {
  id              String    @id @default(uuid())
  listingId       String
  url             String
  
  listing         Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Favorite {
  id              String    @id @default(uuid())
  userId          String
  listingId       String
  createdAt       DateTime  @default(now())

  user            User      @relation(fields: [userId], references: [id])
  listing         Listing   @relation(fields: [listingId], references: [id])

  @@unique([userId, listingId])
}

model Chat {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  participants    User[]    @relation("UserChats")
  messages        Message[]
}

model Message {
  id              String    @id @default(uuid())
  chatId          String
  senderId        String
  content         String
  createdAt       DateTime  @default(now())
  read            Boolean   @default(false)

  chat            Chat      @relation(fields: [chatId], references: [id])
  sender          User      @relation("SentMessages", fields: [senderId], references: [id])
}

model VerificationRequest {
  id              String    @id @default(uuid())
  userId          String    @unique
  documentUrl     String
  status          VerificationStatus @default(PENDING)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id])
}

model AdminAction {
  id              String    @id @default(uuid())
  adminId         String
  actionType      String    // "APPROVE_LISTING", "REJECT_LISTING", "BAN_USER"
  targetId        String
  reason          String?
  createdAt       DateTime  @default(now())

  admin           User      @relation(fields: [adminId], references: [id])
}

// model VectorStore {
//   id              String    @id @default(uuid())
//   content         String
//   metadata        Json?
//   embedding       Unsupported("vector(1536)")? // Requires pgvector extension
//   createdAt       DateTime  @default(now())
// }

enum VisitStatus {
  REQUESTED
  ACCEPTED
  DECLINED
  SCHEDULED
  COMPLETED
  CANCELLED
}

model VisitRequest {
  id              String      @id @default(uuid())
  listingId       String
  requesterId     String
  ownerId         String
  proposedTimes   Json        // Array of proposed times
  scheduledTime   DateTime?
  message         String?
  status          VisitStatus @default(REQUESTED)
  declineReason   String?
  notes           String?
  rating          Int?
  completedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  listing         Listing     @relation(fields: [listingId], references: [id])
  requester       User        @relation("VisitRequester", fields: [requesterId], references: [id])
  owner           User        @relation("VisitOwner", fields: [ownerId], references: [id])
}

model ListingView {
  id              String    @id @default(uuid())
  listingId       String
  viewerId        String?   // Null if not logged in
  sessionId       String
  ipHash          String
  userAgent       String?
  timestamp       DateTime  @default(now())

  listing         Listing   @relation(fields: [listingId], references: [id])
  viewer          User?     @relation(fields: [viewerId], references: [id])
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

model Report {
  id              String        @id @default(uuid())
  reporterId      String
  targetType      String        // "USER" or "LISTING"
  targetId        String
  reason          String
  description     String?
  status          ReportStatus  @default(PENDING)
  adminNotes      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  reporter        User          @relation(fields: [reporterId], references: [id])
}

enum NotificationType {
  NEW_MESSAGE
  VISIT_REQUEST
  VISIT_ACCEPTED
  VISIT_DECLINED
  LISTING_APPROVED
  LISTING_REJECTED
  ACCOUNT_WARNING
  SYSTEM
}

model Notification {
  id              String            @id @default(uuid())
  userId          String
  type            NotificationType
  title           String
  message         String
  data            Json?             // Additional data
  read            Boolean           @default(false)
  createdAt       DateTime          @default(now())

  user            User              @relation(fields: [userId], references: [id])
}
